#!/usr/bin/env ruby

# This script simplifies the usage of `katapult` by grouping relevant actions
# that the user else had to perform manually.

usage = 'Usage: katapult [new APP_NAME | fire [path/to/model] ]'

require_relative '../lib/katapult/binary_util'
util = Katapult::BinaryUtil

require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.on '-u', '--db-user USER', 'Database user name' do |name|
    options[:dbuser] = name
  end
  opts.on '-p', '--db-password PASS', 'Database password' do |password|
    options[:dbpass] = password
  end
  opts.on '-r', '--ruby-version VERSION', 'Ruby version' do |version|
    options[:rubyversion] = version
  end
  opts.on '-v', '--verbose', 'Verbose output' do |verbose|
    options[:verbose] = verbose
  end
end.parse!

case ARGV.shift
when 'new'
  app_name = ARGV.shift || util.ask('Please enter the application name:')
  app_name = util.snake_case(app_name)
  puts "Normalized application name: #{app_name}" if options[:verbose]

  # Any options that haven't be passed via command line should be asked for
  options[:dbuser] ||= util.ask 'Please enter the database user:'
  options[:dbpass] ||= util.ask 'Please enter the database password:'
  options[:rubyversion] ||= begin
    ruby_version = `ruby -v`.chomp
    puts '', "Current Ruby version is: #{ruby_version}"
    util.ask 'Please enter the Ruby version for the new project:'
  end

  basics_command = 'bundle exec rails generate katapult:basics'
  basics_command << ' --db-user ' << options[:dbuser]
  basics_command << ' --db-password ' << options[:dbpass]

  util.pink "Creating new Rails application in #{app_name} ..."
  util.create_rails_app app_name
  Dir.chdir app_name

  util.pink 'Writing .ruby-version ...'
  File.open('.ruby-version', 'w') do |file|
    file.puts options[:rubyversion]
  end

  util.pink 'Initializing git repository ...'
  util.run 'git init --quiet'
  util.git_commit "rails new #{ app_name }", '--quiet'

  util.pink 'Installing katapult ...'
  File.open('Gemfile', 'a') do |file|
    file.puts "gem 'katapult'#{ ENV['KATAPULT_GEMFILE_OPTIONS'] }, group: :development"
  end
  util.run 'bundle install --quiet'
  util.run 'bundle exec rails generate katapult:install'
  util.git_commit 'rails generate katapult:install', '--quiet'

  util.pink 'Generating katapult basics ...'
  util.run basics_command
  # Do not use `basics_command` as commit message, as it contains the password!
  util.git_commit 'rails generate katapult:basics', '--quiet'

  util.pink <<-INSTRUCTIONS
Application initialization done.

Next step: Model your application in lib/katapult/application_model.rb and
transform it into code by running `katapult fire`.
  INSTRUCTIONS

when 'fire'
  app_model_path = ARGV.shift || 'lib/katapult/application_model.rb'
  transform_command = 'bin/rails generate katapult:transform ' + app_model_path

  util.pink 'Loading katapult ...'
  util.run transform_command

  util.pink 'Committing result ...'
  util.git_commit transform_command

  util.pink <<-INSTRUCTIONS
Model transformation done.

Now boot up your development server (e.g. with `rails server`) and try your
kickstarted application in the browser!
  INSTRUCTIONS

else
  puts usage
end
